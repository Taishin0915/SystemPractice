{% extends "base.html" %}

{% block title %}書籍管理 - 図書館予約管理システム{% endblock %}

{% block content %}
<div class="page-header">
    <h1>書籍管理</h1>
    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">ダッシュボードに戻る</a>
</div>

<div class="admin-section">
    <h2>書籍を追加</h2>
    <form method="POST" action="{{ url_for('admin_books') }}" class="book-form">
        <input type="hidden" name="action" value="add">
        <div class="form-row">
            <div class="form-group">
                <label for="title">タイトル *</label>
                <input type="text" id="title" name="title" required>
            </div>
            <div class="form-group">
                <label for="author">著者 *</label>
                <input type="text" id="author" name="author" required>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="isbn">ISBN</label>
                <input type="text" id="isbn" name="isbn">
            </div>
            <div class="form-group">
                <label for="publisher">出版社</label>
                <input type="text" id="publisher" name="publisher">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="publication_date">出版日</label>
                <input type="date" id="publication_date" name="publication_date">
            </div>
            <div class="form-group">
                <label for="total_copies">総冊数 *</label>
                <input type="number" id="total_copies" name="total_copies" min="1" value="1" required>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">追加</button>
    </form>
</div>

<div class="admin-section">
    <h2>書籍一覧</h2>
    {% if books %}
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>タイトル</th>
                        <th>著者</th>
                        <th>ISBN</th>
                        <th>在庫</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for book in books %}
                        <tr>
                            <td>{{ book.id }}</td>
                            <td>{{ book.title }}</td>
                            <td>{{ book.author }}</td>
                            <td>{{ book.isbn or '-' }}</td>
                            <td>{{ book.available_copies }}/{{ book.total_copies }}</td>
                            <td>
                                <button onclick="editBook({{ book.id }}, '{{ book.title }}', '{{ book.author }}', '{{ book.isbn or '' }}', '{{ book.publisher or '' }}', '{{ book.publication_date.strftime('%Y-%m-%d') if book.publication_date else '' }}', {{ book.total_copies }})" class="btn btn-sm btn-secondary">編集</button>
                                <form method="POST" action="{{ url_for('admin_books') }}" style="display: inline;">
                                    <input type="hidden" name="action" value="delete">
                                    <input type="hidden" name="book_id" value="{{ book.id }}">
                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('この書籍を削除しますか？')">削除</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="empty-state">
            <p>書籍がありません。</p>
        </div>
    {% endif %}
</div>

<!-- 編集モーダル -->
<div id="editModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2>書籍を編集</h2>
        <form method="POST" action="{{ url_for('admin_books') }}" class="book-form">
            <input type="hidden" name="action" value="edit">
            <input type="hidden" id="edit_book_id" name="book_id">
            <div class="form-row">
                <div class="form-group">
                    <label for="edit_title">タイトル *</label>
                    <input type="text" id="edit_title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="edit_author">著者 *</label>
                    <input type="text" id="edit_author" name="author" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="edit_isbn">ISBN</label>
                    <input type="text" id="edit_isbn" name="isbn">
                </div>
                <div class="form-group">
                    <label for="edit_publisher">出版社</label>
                    <input type="text" id="edit_publisher" name="publisher">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="edit_publication_date">出版日</label>
                    <input type="date" id="edit_publication_date" name="publication_date">
                </div>
                <div class="form-group">
                    <label for="edit_total_copies">総冊数 *</label>
                    <input type="number" id="edit_total_copies" name="total_copies" min="1" required>
                </div>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">更新</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">キャンセル</button>
            </div>
        </form>
    </div>
</div>

<script>
function editBook(id, title, author, isbn, publisher, publicationDate, totalCopies) {
    document.getElementById('edit_book_id').value = id;
    document.getElementById('edit_title').value = title;
    document.getElementById('edit_author').value = author;
    document.getElementById('edit_isbn').value = isbn || '';
    document.getElementById('edit_publisher').value = publisher || '';
    document.getElementById('edit_publication_date').value = publicationDate || '';
    document.getElementById('edit_total_copies').value = totalCopies;
    document.getElementById('editModal').style.display = 'block';
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}

window.onclick = function(event) {
    const modal = document.getElementById('editModal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}
</script>
{% endblock %}

